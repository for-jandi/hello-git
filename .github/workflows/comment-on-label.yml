name: Comment on `order` PR labels

on:
  pull_request:
    types: [labeled]

jobs:
  comment-on-order:
    runs-on: ubuntu-latest
    steps:
      - name: Add comments for `order` label and HTTP methods
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const prUrl = pr.html_url;
            const branch = `${pr.head.ref} â†’ ${pr.base.ref}`;
            const author = pr.user.login;
            const labels = pr.labels.map(label => label.name.toLowerCase());

            if (!labels.includes('order')) {
              console.log('`order` ë¼ë²¨ì´ ì—†ìœ¼ë¯€ë¡œ ì¢…ë£Œí•©ë‹ˆë‹¤.');
              return;
            }

            // ğŸ“Œ ê¸°ì¡´ ì½”ë©˜íŠ¸ ì¡°íšŒ (ì¤‘ë³µ ë°©ì§€ìš©)
            const existingComments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
            });

            // âœ… ê¸°ë³¸ ì½”ë©˜íŠ¸ ì‘ì„±
            const baseId = 'order-pr-label-bot';
            const hasBaseComment = existingComments.data.some(c =>
              c.body.includes(`<!-- ${baseId} -->`)
            );

            const methodLabels = ['post', 'get', 'put', 'delete'];
            const attachedMethods = methodLabels.filter(m => labels.includes(m));
            const missingMethodMessage = attachedMethods.length === 0
              ? `\n\nâ— **ìš”ì²­ ë©”ì„œë“œ ë¼ë²¨ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.**\n\n\`post\`, \`get\`, \`put\`, \`delete\` ì¤‘ ì ì ˆí•œ ë¼ë²¨ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”!`
              : '';

            if (!hasBaseComment) {
              const baseComment = `<!-- ${baseId} -->
              ### ğŸ“¦ Order PR ë¼ë²¨ ì•ˆë‚´ ë´‡ì…ë‹ˆë‹¤
              
              ì´ PRì—ëŠ” \`order\` ë¼ë²¨ì´ ê°ì§€ë˜ì–´ ì•ˆë‚´ ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.  
              ì´ ë´‡ì€ PRì— HTTP ë©”ì„œë“œ ë¼ë²¨ì´ ë¶™ì–´ ìˆìœ¼ë©´ ê° ìš”ì²­ ìœ í˜•ì— ë§ëŠ” ì½”ë©˜íŠ¸ë¥¼ ì¶”ê°€ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.${missingMethodMessage}
              
              - PR: [#${prNumber}](${prUrl})
              - ë¸Œëœì¹˜: \`${branch}\`
              - ì‘ì„±ì: @${author}
              
              ---
              _ì´ ì½”ë©˜íŠ¸ëŠ” ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤._ ğŸ¤–`;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: baseComment,
              });
              console.log('âœ… ê¸°ë³¸ ì½”ë©˜íŠ¸ ì‘ì„± ì™„ë£Œ');
            } else {
              console.log('â„¹ï¸ ê¸°ë³¸ ì½”ë©˜íŠ¸ëŠ” ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ìƒëµí•¨');
            }

            // âœ… ë©”ì„œë“œë³„ ì½”ë©˜íŠ¸
            const methodMessages = {
              post: {
                id: 'order-method-post',
                body: `### ğŸ“¬ POST ìš”ì²­ ì²˜ë¦¬ ì¶”ê°€ë¨
                
                \`order\` ëª¨ë“ˆì—ì„œ **POST ìš”ì²­ ì²˜ë¦¬**ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.  
                ê²€í† ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                
                - PR: [#${prNumber}](${prUrl})
                - ë¸Œëœì¹˜: \`${branch}\`
                - ì‘ì„±ì: @${author}
                `
            },
            get: {
              id: 'order-method-get',
              body: `### ğŸ“¥ GET ìš”ì²­ ì²˜ë¦¬ ë³€ê²½ë¨

                \`order\` ëª¨ë“ˆì—ì„œ **GET ìš”ì²­ ê´€ë ¨ ë³€ê²½**ì´ ìˆìŠµë‹ˆë‹¤.
                
                - PR: [#${prNumber}](${prUrl})
                - ë¸Œëœì¹˜: \`${branch}\`
                - ì‘ì„±ì: @${author}
                `
              },
              put: {
                id: 'order-method-put',
                body: `### ğŸ› ï¸ PUT ìš”ì²­ ì²˜ë¦¬ ìˆ˜ì •ë¨
                
                \`order\` ëª¨ë“ˆì˜ **PUT ìš”ì²­ ì²˜ë¦¬ ë¡œì§**ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.
                
                - PR: [#${prNumber}](${prUrl})
                - ë¸Œëœì¹˜: \`${branch}\`
                - ì‘ì„±ì: @${author}
              `
              },
              delete: {
                id: 'order-method-delete',
                body: `### ğŸ—‘ï¸ DELETE ìš”ì²­ ì²˜ë¦¬ í¬í•¨ë¨
  
                \`order\` ëª¨ë“ˆì— **DELETE ìš”ì²­ ì²˜ë¦¬**ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.  
                ë°ì´í„° ì‚­ì œ ë¡œì§ì´ ì•ˆì „í•˜ê²Œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.
              
              - PR: [#${prNumber}](${prUrl})
              - ë¸Œëœì¹˜: \`${branch}\`
              - ì‘ì„±ì: @${author}
              `
              },
            };

            for (const method of attachedMethods) {
              const { id, body } = methodMessages[method];
              const hasComment = existingComments.data.some(c =>
                c.body.includes(`<!-- ${id} -->`)
              );

              if (!hasComment) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: prNumber,
                  body: `<!-- ${id} -->\n${body}`,
                });
                console.log(`âœ… ${method.toUpperCase()} ì½”ë©˜íŠ¸ ì‘ì„± ì™„ë£Œ`);
              } else {
                console.log(`â„¹ï¸ ${method.toUpperCase()} ì½”ë©˜íŠ¸ëŠ” ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ìƒëµí•¨`);
              }
            }
