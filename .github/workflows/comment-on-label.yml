name: PR Comment for Order Label

on:
  pull_request:
    types: [labeled, unlabeled]

jobs:
  comment-on-label:
    runs-on: ubuntu-latest
    if: github.event.pull_request.state == 'open'
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const labelName = context.payload.label?.name?.toLowerCase();

            const defaultCommentId = 'order-pr-label-bot';
            const methodLabels = ['post', 'get', 'put', 'delete'];

            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
            });

            const findCommentById = (id) =>
              comments.data.find(c => c.body.includes(`<!-- ${id} -->`));

            if (context.payload.action === 'labeled') {
              if (labelName === 'order') {
                const existing = findCommentById(defaultCommentId);
                if (!existing) {
                  const body = `<!-- ${defaultCommentId} -->
                  ğŸ”” ì´ PRì€ \`order\` ë¼ë²¨ì´ ì§€ì •ë˜ì–´ ìë™ ì•ˆë‚´ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
                  
                  âœ… ì•„ë˜ HTTP ë©”ì„œë“œ ë¼ë²¨ ì¤‘ í•´ë‹¹ë˜ëŠ” ê²ƒì„ ì¶”ê°€í•´ì£¼ì„¸ìš”:
                  
                  \`post\`, \`get\`, \`put\`, \`delete\`
                  
                  ë¼ë²¨ì„ ì œê±°í•˜ë©´ í•´ë‹¹ ì•ˆë‚´ë„ ì‚­ì œë©ë‹ˆë‹¤.`;
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: prNumber,
                    body,
                  });
                }
              }

              if (methodLabels.includes(labelName)) {
                const id = `order-method-${labelName}`;
                const existing = findCommentById(id);
                if (!existing) {
                  const body = `<!-- ${id} -->
                  ğŸ“¦ \`${labelName.toUpperCase()}\` ë©”ì„œë“œì— ëŒ€í•œ ì²˜ë¦¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
                  
                  - API ëª…ì„¸, ì˜ˆì™¸ ì²˜ë¦¬, ì‘ë‹µ í¬ë§· ë“±ì„ ì ê²€í–ˆë‚˜ìš”?
                  - ì ì ˆí•œ ì¸ì¦/ê¶Œí•œ ì²´í¬ê°€ í¬í•¨ë˜ì–´ ìˆë‚˜ìš”?
                  `;
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: prNumber,
                    body,
                  });
                }
              }
            }

            if (context.payload.action === 'unlabeled') {
              if (methodLabels.includes(labelName)) {
                const id = `order-method-${labelName}`;
                const existing = findCommentById(id);
                if (existing) {
                  await github.rest.issues.deleteComment({
                    owner,
                    repo,
                    comment_id: existing.id,
                  });
                }
              }
            }
